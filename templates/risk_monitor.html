{% extends "base.html" %}
{% block title %}ExplainDengue - Risk Monitor Dashboard{% endblock %}
{% block content %}

<h1 class="text-4xl font-bold mb-8 text-center text-blue-600">Risk Monitor Dashboard</h1>

<div id="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
    <span id="errorText" class="block sm:inline"></span>
</div>

<div class="mb-4">
    <input type="text" id="citySearch" placeholder="Search for a city" class="w-full p-2 border rounded">
</div>

<div id="cityGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- City cards will be dynamically inserted here -->
</div>

<!-- Modal for detailed city view -->
<div id="cityModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
        <div id="modalContent" class="max-h-[80vh] overflow-y-auto">
            <!-- Detailed city information will be inserted here -->
        </div>
        <div class="text-center mt-4">
            <button id="closeModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                Close
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cityGrid = document.getElementById('cityGrid');
    const cityModal = document.getElementById('cityModal');
    const modalContent = document.getElementById('modalContent');
    const closeModal = document.getElementById('closeModal');
    const citySearch = document.getElementById('citySearch');

    function fetchRiskData() {
        fetch('/get_risk_data')
            .then(response => response.json())
            .then(data => {
                cityGrid.innerHTML = '';
                data.forEach(city => {
                    const card = createCityCard(city);
                    cityGrid.appendChild(card);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = 'Failed to fetch risk data. Please try again later.';
            });
    }

    function createCityCard(city) {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow duration-300';
        card.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">${city.city}</h2>
            <p class="mb-2">Risk Level: <span class="font-bold ${getRiskColor(city.risk_level)}">${city.risk_level}</span></p>
            <p class="mb-2">
                ${getWeatherIcon(city.temperature, city.rainfall)}
                ${city.temperature.toFixed(1)}¬∞C / ${city.rainfall.toFixed(1)}mm
            </p>
            <p>Population: ${city.population.toLocaleString()}</p>
        `;
        card.addEventListener('click', () => showCityDetails(city));
        return card;
    }

    function getRiskColor(riskLevel) {
        switch (riskLevel) {
            case 'High': return 'text-red-600';
            case 'Moderate': return 'text-yellow-600';
            case 'Low': return 'text-green-600';
            default: return 'text-gray-600';
        }
    }

    function getWeatherIcon(temperature, rainfall) {
        if (temperature > 30) {
            return 'üåû';
        } else if (rainfall > 100) {
            return 'üåßÔ∏è';
        } else {
            return '‚õÖ';
        }
    }

    function showCityDetails(city) {
        modalContent.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">${city.city} - Detailed View</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2">Risk Level</h3>
                    <div class="h-40">
                        <canvas id="riskGauge"></canvas>
                    </div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <h3 class="text-xl font-semibold mb-2">Predicted Cases</h3>
                    <div class="h-40">
                        <canvas id="casesChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Temperature</h3>
                    <div class="h-32">
                        <canvas id="tempGauge"></canvas>
                    </div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Rainfall</h3>
                    <div class="h-32">
                        <canvas id="rainfallChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-semibold mb-2">Population</h3>
                    <p class="text-3xl font-bold">${city.population.toLocaleString()}</p>
                </div>
            </div>
            
            <h3 class="text-xl font-semibold mb-2">Explanation</h3>
            <div id="explanation" class="mb-4 p-3 bg-gray-100 rounded">
                ${generateExplanation(city)}
            </div>
            
            <h3 class="text-xl font-semibold mb-2">Neighboring Cities with Elevated Risk</h3>
            <div id="neighboringCities" class="mb-4 p-3 bg-gray-100 rounded">
                ${generateNeighboringCitiesInfo(city)}
            </div>
            
            <h3 class="text-xl font-semibold mb-2">Recommendations</h3>
            <ul id="recommendations" class="mb-4 list-disc pl-5">
                ${generateRecommendations(city)}
            </ul>
        `;
        cityModal.classList.remove('hidden');
        
        // Create visualizations
        createRiskGauge(city.risk_level);
        createCasesChart(city.prediction);
        createTempGauge(city.temperature);
        createRainfallChart(city.rainfall);
    }

    function createRiskGauge(riskLevel) {
        const ctx = document.getElementById('riskGauge').getContext('2d');
        const riskValues = { 'Low': 1, 'Moderate': 2, 'High': 3 };
        const value = riskValues[riskLevel];
        
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [value, 3 - value],
                    backgroundColor: [
                        value === 1 ? '#4CAF50' : value === 2 ? '#FFC107' : '#F44336',
                        'rgba(0, 0, 0, 0.1)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                circumference: 180,
                rotation: -90,
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'riskText',
                afterDraw: (chart, args, options) => {
                    const {ctx, chartArea: {top, right, bottom, left, width, height}} = chart;
                    ctx.save();
                    
                    const centerX = left + width / 2;
                    const centerY = top + height / 2;
                    
                    // Risk Level
                    ctx.font = 'bold 16px Arial';
                    ctx.fillStyle = value === 1 ? '#4CAF50' : value === 2 ? '#FFC107' : '#F44336';
                    ctx.fillText(riskLevel, centerX, centerY + 15);
                    
                    // Numerical Value
                    ctx.font = 'bold 24px Arial';
                    ctx.fillText(value.toString(), centerX, centerY - 15);
                    
                    ctx.restore();
                }
            }]
        });
    }

    function createTempGauge(temperature) {
        const ctx = document.getElementById('tempGauge').getContext('2d');
        const maxTemp = 50;
        
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [temperature, maxTemp - temperature],
                    backgroundColor: [
                        temperature > 30 ? '#F44336' : temperature > 20 ? '#FFC107' : '#4CAF50',
                        'rgba(0, 0, 0, 0.1)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                circumference: 180,
                rotation: -90,
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            },
            plugins: [{
                id: 'tempText',
                afterDraw: (chart, args, options) => {
                    const {ctx, chartArea: {top, right, bottom, left, width, height}} = chart;
                    ctx.save();
                    
                    const centerX = left + width / 2;
                    const centerY = top + height / 2;
                    
                    // Temperature Value
                    ctx.font = 'bold 20px Arial';
                    ctx.fillStyle = '#000';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(temperature.toFixed(1) + '¬∞C', centerX, centerY - 10);
                    
                    // Label
                    ctx.font = '14px Arial';
                    ctx.fillText('Temperature', centerX, centerY + 20);
                    
                    ctx.restore();
                }
            }]
        });
    }

    function createCasesChart(prediction) {
        const ctx = document.getElementById('casesChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Predicted Cases'],
                datasets: [{
                    data: [prediction],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function createRainfallChart(rainfall) {
        const ctx = document.getElementById('rainfallChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Rainfall'],
                datasets: [{
                    data: [rainfall],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'mm'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    function generateExplanation(city) {
        let explanation = `The risk level for ${city.city} is currently <strong>${city.risk_level}</strong>. `;
        
        explanation += `Based on our graph-based model, which considers the interconnectedness of cities, `;
        
        if (city.temperature > 30) {
            explanation += `the high temperature of ${city.temperature.toFixed(1)}¬∞C provides favorable conditions for mosquito breeding. `;
        }
        
        if (city.rainfall > 100) {
            explanation += `The heavy rainfall of ${city.rainfall.toFixed(1)}mm increases the likelihood of standing water, which are ideal breeding sites for mosquitoes. `;
        }
        
        if (city.population > 1000000) {
            explanation += `The large population of ${city.population.toLocaleString()} increases the potential for rapid disease spread. `;
        }
        
        explanation += `Our model also considers the situation in neighboring cities, as dengue outbreaks can spread across regions. `;
        explanation += `Based on these factors and the network effects, our model predicts approximately ${city.prediction.toFixed(2)} dengue cases in the near future.`;
        
        return explanation;
    }

    function generateNeighboringCitiesInfo(city) {
        if (!city.neighboring_cities || city.neighboring_cities.length === 0) {
            return "No neighboring cities currently show elevated risk.";
        }
        
        let info = "The following neighboring cities show elevated risk levels:<ul>";
        city.neighboring_cities.forEach(neighbor => {
            info += `<li>${neighbor.name} (Risk Level: ${neighbor.risk_level})</li>`;
        });
        info += "</ul>";
        
        return info;
    }

    function generateRecommendations(city) {
        const baseRecommendations = {
            'High': [
                "Intensify vector control measures in high-risk areas",
                "Conduct emergency community awareness campaigns",
                "Ensure hospitals are prepared for a potential outbreak",
                "Implement daily monitoring of reported dengue cases"
            ],
            'Moderate': [
                "Continue regular mosquito control activities",
                "Encourage community participation in eliminating mosquito breeding sites",
                "Monitor local health facilities for increased dengue cases",
                "Conduct targeted awareness campaigns in vulnerable areas"
            ],
            'Low': [
                "Maintain routine surveillance and mosquito control measures",
                "Educate the public on personal protection measures",
                "Keep emergency response plans updated",
                "Continue monitoring weather patterns and population dynamics"
            ]
        };

        let recommendations = baseRecommendations[city.risk_level];
        
        // Add network-based recommendations
        if (city.neighboring_cities && city.neighboring_cities.length > 0) {
            recommendations.push("Coordinate prevention efforts with neighboring high-risk cities");
            recommendations.push("Monitor travel patterns between your city and high-risk neighboring cities");
        }

        return recommendations.map(rec => `<li>${rec}</li>`).join('');
    }


    closeModal.addEventListener('click', () => {
        cityModal.classList.add('hidden');
    });

    citySearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        Array.from(cityGrid.children).forEach(card => {
            const cityName = card.querySelector('h2').textContent.toLowerCase();
            card.style.display = cityName.includes(searchTerm) ? '' : 'none';
        });
    });

    fetchRiskData();
});
</script>
{% endblock %}